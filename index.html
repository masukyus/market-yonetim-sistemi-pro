<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#9333ea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Oyunla≈ütƒ±rƒ±lmƒ±≈ü SKT Kontrol ve Stok Y√∂netimi - √áoklu Kullanƒ±cƒ± Sistemi">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:; manifest-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';">
    <title>SKT Kontrol - √áoklu Kullanƒ±cƒ± Y√∂netim Sistemi</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÜ</text></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- External Libraries -->
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-slide-in { animation: slideInUp 0.4s ease-out; }
        .animate-scale-in { animation: scaleIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50">
    <div id="app"></div>
    <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-3"></div>

    <script>
        console.log('[APP] Multi-User Market Y√∂netim Sistemi ba≈ülatƒ±lƒ±yor...');

        // ============================================
        // PRODUCT CATALOG SYSTEM
        // ============================================

        class ProductCatalog {
            constructor() {
                this.products = [];
                this.loaded = false;
                this.loadCatalog();
            }

            async loadCatalog() {
                try {
                    const response = await fetch('./product-catalog.json');
                    if (!response.ok) throw new Error('Katalog y√ºklenemedi');
                    const data = await response.json();
                    this.products = data.products || [];
                    this.loaded = true;
                    console.log('[CATALOG] Katalog y√ºklendi:', this.products.length, '√ºr√ºn');
                } catch (error) {
                    console.error('[CATALOG] Y√ºkleme hatasƒ±:', error);
                    this.products = [];
                    this.loaded = false;
                }
            }

            findByBarcode(barcode) {
                if (!this.loaded) {
                    console.warn('[CATALOG] Katalog hen√ºz y√ºklenmedi');
                    return null;
                }
                return this.products.find(p => p.barcode === barcode);
            }

            getDefaultLocation(barcode) {
                const product = this.findByBarcode(barcode);
                return product?.locations?.[0] || 'Depo A';
            }

            getDefaultExpiry(barcode) {
                const product = this.findByBarcode(barcode);
                if (product?.expiryDays) {
                    const date = new Date();
                    date.setDate(date.getDate() + product.expiryDays);
                    return date.toISOString().split('T')[0];
                }
                return '';
            }
        }

        const productCatalog = new ProductCatalog();

        // ============================================
        // ADVANCED DATA MANAGEMENT SYSTEM
        // ============================================

        class UserSystem {
            constructor() {
                this.users = this.loadData('users') || {};
                this.auditLog = this.loadData('auditLog') || [];
                this.currentUser = null;
                this.loadCurrentUser();
            }

            // Veri y√ºkleme
            loadData(key) {
                try {
                    return JSON.parse(localStorage.getItem(`skm_${key}`));
                } catch (e) {
                    console.error('Load error:', e);
                    return null;
                }
            }

            // Veri kaydetme
            saveData(key, data) {
                try {
                    localStorage.setItem(`skm_${key}`, JSON.stringify(data));
                    return true;
                } catch (e) {
                    console.error('Save error:', e);
                    return false;
                }
            }

            // Audit logging
            log(action, details = {}) {
                const logEntry = {
                    timestamp: new Date().toISOString(),
                    userId: this.currentUser?.id || 'system',
                    username: this.currentUser?.username || 'System',
                    action,
                    details,
                    userAgent: navigator.userAgent
                };
                this.auditLog.push(logEntry);
                this.saveData('auditLog', this.auditLog);
                console.log('[AUDIT]', logEntry);
            }

            // Mevcut kullanƒ±cƒ±yƒ± y√ºkle
            loadCurrentUser() {
                const saved = sessionStorage.getItem('skm_currentUser');
                this.currentUser = saved ? JSON.parse(saved) : null;
            }

            // Kullanƒ±cƒ± kaydƒ±
            register(username, email, password, fullName) {
                if (this.users[username]) {
                    return { success: false, message: 'Kullanƒ±cƒ± zaten var!' };
                }

                const userId = Date.now().toString();
                this.users[username] = {
                    id: userId,
                    username,
                    email,
                    password: this.hashPassword(password),
                    fullName,
                    createdAt: new Date().toISOString(),
                    role: 'user',
                    active: true,
                    products: [],
                    stats: {
                        totalPoints: 0,
                        level: 1,
                        streak: 0,
                        todayScans: 0,
                        weeklyScans: 0,
                        badges: [],
                        lastScanDate: null
                    }
                };

                this.saveData('users', this.users);
                this.log('USER_REGISTERED', { username, email, fullName });
                return { success: true, message: 'Kayƒ±t ba≈üarƒ±lƒ±!' };
            }

            // Giri≈ü
            login(username, password) {
                const user = this.users[username];
                if (!user) {
                    this.log('LOGIN_FAILED', { username, reason: 'User not found' });
                    return { success: false, message: 'Kullanƒ±cƒ± bulunamadƒ±!' };
                }

                if (user.password !== this.hashPassword(password)) {
                    this.log('LOGIN_FAILED', { username, reason: 'Wrong password' });
                    return { success: false, message: '≈ûifre yanlƒ±≈ü!' };
                }

                if (!user.active) {
                    return { success: false, message: 'Bu hesap deaktif edilmi≈ütir!' };
                }

                this.currentUser = {
                    id: user.id,
                    username: user.username,
                    fullName: user.fullName,
                    role: user.role,
                    email: user.email
                };

                sessionStorage.setItem('skm_currentUser', JSON.stringify(this.currentUser));
                this.log('LOGIN_SUCCESS', { username });
                return { success: true, message: 'Giri≈ü ba≈üarƒ±lƒ±!', user: this.currentUser };
            }

            // √áƒ±kƒ±≈ü
            logout() {
                this.log('LOGOUT', { username: this.currentUser?.username });
                sessionStorage.removeItem('skm_currentUser');
                this.currentUser = null;
            }

            // Basit hash (ger√ßek uygulamada bcrypt kullanƒ±n!)
            hashPassword(password) {
                return btoa(password).slice(0, 32);
            }

            // Kullanƒ±cƒ± verisini al
            getUser(username) {
                return this.users[username];
            }

            // T√ºm√º kullanƒ±cƒ±larƒ± al (admin i√ßin)
            getAllUsers() {
                return Object.values(this.users);
            }

            // √úr√ºn ekle
            addProduct(username, product) {
                const user = this.users[username];
                if (!user) return { success: false };

                const newProduct = {
                    id: Date.now(),
                    ...product,
                    timestamp: new Date().toISOString(),
                    scannedBy: username
                };

                user.products.unshift(newProduct);
                
                // ƒ∞statistikleri g√ºncelle
                const statusPoints = this.calculatePoints(product.status);
                user.stats.totalPoints += statusPoints;
                user.stats.todayScans += 1;
                user.stats.weeklyScans += 1;
                user.stats.level = Math.floor(user.stats.totalPoints / 100) + 1;

                this.saveData('users', this.users);
                this.log('PRODUCT_ADDED', { username, productName: product.name, barcode: product.barcode });
                
                return { success: true, product: newProduct };
            }

            // √úr√ºn sil
            deleteProduct(username, productId) {
                const user = this.users[username];
                if (!user) return { success: false };

                const product = user.products.find(p => p.id === productId);
                user.products = user.products.filter(p => p.id !== productId);
                
                this.saveData('users', this.users);
                this.log('PRODUCT_DELETED', { username, productId, productName: product?.name });
                
                return { success: true };
            }

            // Puan hesapla
            calculatePoints(status) {
                if (status === 'SKT GE√áTƒ∞') return 50;
                if (status === 'SKT YAKLA≈ûIYOR') return 30;
                return 10;
            }

            // Status hesapla
            calculateStatus(expiryDate) {
                const today = new Date();
                const expiry = new Date(expiryDate);
                const diffTime = expiry - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) {
                    return { status: 'SKT GE√áTƒ∞', color: 'bg-red-500', textColor: 'text-red-600', daysLeft: diffDays };
                }
                if (diffDays <= 30) {
                    return { status: 'SKT YAKLA≈ûIYOR', color: 'bg-yellow-500', textColor: 'text-yellow-600', daysLeft: diffDays };
                }
                return { status: 'UYGUN', color: 'bg-green-500', textColor: 'text-green-600', daysLeft: diffDays };
            }

            // Leaderboard olu≈ütur
            getLeaderboard() {
                return Object.values(this.users)
                    .map(user => ({
                        username: user.username,
                        fullName: user.fullName,
                        points: user.stats.totalPoints,
                        level: user.stats.level,
                        scans: user.stats.weeklyScans,
                        products: user.products.length
                    }))
                    .sort((a, b) => b.points - a.points);
            }
        }

        const userSystem = new UserSystem();
        const productCatalog = new ProductCatalog();

        // Katalog y√ºklendiƒüini kontrol et (debug i√ßin)
        productCatalog.loadCatalog().then(() => {
            console.log('[INIT] √úr√ºn kataloƒüu ba≈üarƒ±yla y√ºklendi');
        }).catch(err => {
            console.error('[INIT] Katalog y√ºkleme hatasƒ±:', err);
        });

        // ============================================
        // UI RENDERING
        // ============================================

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500' };
            const icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è' };

            const toast = document.createElement('div');
            toast.className = `${colors[type]} text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 animate-slide-in`;
            toast.innerHTML = `<span class="text-2xl">${icons[type]}</span><span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!userSystem.currentUser) {
                app.innerHTML = renderAuthScreen();
            } else {
                if (userSystem.currentUser.role === 'admin') {
                    app.innerHTML = renderAdminPanel();
                } else {
                    app.innerHTML = renderMainApp();
                }
            }
        }

        function renderAuthScreen() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-purple-600 to-pink-600">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8">
                        <div class="text-center mb-8">
                            <div class="text-5xl mb-3">üè™</div>
                            <h1 class="text-3xl font-bold text-gray-800">Market Y√∂netim</h1>
                            <p class="text-gray-600 mt-2">√áoklu Kullanƒ±cƒ± Sistemi</p>
                        </div>

                        <div id="authForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Kullanƒ±cƒ± Adƒ±</label>
                                <input id="username" type="text" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Kullanƒ±cƒ± adƒ±nƒ±z">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">≈ûifre</label>
                                <input id="password" type="password" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="≈ûifreniz">
                            </div>
                            <div id="registerFields" style="display:none;">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ad Soyad</label>
                                    <input id="fullName" type="text" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="Adƒ±nƒ±z Soyadƒ±nƒ±z">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                                    <input id="email" type="email" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none" placeholder="email@example.com">
                                </div>
                            </div>

                            <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg font-bold hover:shadow-lg transition-all">
                                Giri≈ü Yap
                            </button>

                            <div class="text-center text-sm text-gray-600">
                                Hesabƒ±nƒ±z yok mu? <a onclick="toggleRegister()" class="text-purple-600 font-semibold cursor-pointer hover:underline">Kaydol</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            const user = userSystem.getUser(userSystem.currentUser.username);
            const expiredCount = user.products.filter(p => p.status === 'SKT GE√áTƒ∞').length;
            const warningCount = user.products.filter(p => p.status === 'SKT YAKLA≈ûIYOR').length;
            const goodCount = user.products.filter(p => p.status === 'UYGUN').length;

            return `
                <div class="min-h-screen">
                    <!-- Header -->
                    <div class="bg-white shadow-lg border-b-4 border-purple-500">
                        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div>
                                <h1 class="text-2xl font-bold text-gray-800">üë§ ${user.fullName}</h1>
                                <p class="text-sm text-gray-600">Seviye ${user.stats.level} ‚Ä¢ ${user.stats.totalPoints} XP</p>
                            </div>
                            <button onclick="userSystem.logout(); render();" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-bold">
                                √áƒ±kƒ±≈ü Yap
                            </button>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="max-w-7xl mx-auto px-4 py-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-blue-500">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-gray-600">Bug√ºn Tarama</p>
                                        <p class="text-3xl font-bold text-gray-800">${user.stats.todayScans}</p>
                                    </div>
                                    <span class="text-4xl">üìä</span>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-green-500">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-gray-600">Haftalƒ±k Tarama</p>
                                        <p class="text-3xl font-bold text-gray-800">${user.stats.weeklyScans}</p>
                                    </div>
                                    <span class="text-4xl">üìà</span>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-purple-500">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-gray-600">SKT Ge√ßti</p>
                                        <p class="text-3xl font-bold text-red-600">${expiredCount}</p>
                                    </div>
                                    <span class="text-4xl">‚ö†Ô∏è</span>
                                </div>
                            </div>

                            <div class="bg-white rounded-xl p-6 shadow-lg border-l-4 border-orange-500">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="text-gray-600">Toplam √úr√ºn</p>
                                        <p class="text-3xl font-bold text-gray-800">${user.products.length}</p>
                                    </div>
                                    <span class="text-4xl">üì¶</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-4 mb-6">
                            <button onclick="showAddProductModal()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold hover:shadow-lg transition-all flex items-center justify-center gap-2">
                                ‚ûï √úr√ºn Ekle
                            </button>
                            <button onclick="viewLeaderboard()" class="flex-1 bg-gradient-to-r from-blue-600 to-cyan-600 text-white py-4 rounded-xl font-bold hover:shadow-lg transition-all flex items-center justify-center gap-2">
                                üèÜ Lider Tablosu
                            </button>
                            <button onclick="viewAuditLog()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white py-4 rounded-xl font-bold hover:shadow-lg transition-all flex items-center justify-center gap-2">
                                üìã ƒ∞≈ülem G√ºnl√ºƒü√º
                            </button>
                        </div>

                        <!-- Products List -->
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Kayƒ±tlƒ± √úr√ºnler</h2>
                            ${user.products.length === 0 ? 
                                '<p class="text-gray-500 py-8">Hen√ºz √ºr√ºn eklenmemi≈ü</p>' 
                                : `
                                <div class="space-y-4">
                                    ${user.products.slice(0, 10).map(product => `
                                        <div class="flex items-start justify-between p-4 border-l-4 ${product.color} bg-gray-50 rounded">
                                            <div class="flex-1">
                                                <h3 class="font-bold text-gray-800">${product.name}</h3>
                                                <p class="text-sm text-gray-600">Barkod: ${product.barcode}</p>
                                                <p class="text-sm text-gray-600">Lokasyon: ${product.location}</p>
                                                <p class="text-sm text-gray-600">SKT: ${new Date(product.expiryDate).toLocaleDateString('tr-TR')}</p>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="${product.color} text-white px-3 py-1 rounded-full text-xs font-bold">${product.status}</span>
                                                <button onclick="userSystem.deleteProduct('${userSystem.currentUser.username}', ${product.id}); render();" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                `
                            }
                        </div>
                    </div>

                    <!-- Add Product Modal -->
                    <div id="productModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
                        <div class="bg-white rounded-2xl p-6 max-w-md w-full shadow-2xl my-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">üì¶ √úr√ºn Ekle</h2>
                            
                            <!-- Barcode Scanner Section -->
                            <div id="scannerSection" class="mb-4 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                                <video id="scannerVideo" style="display:none; width:100%; border-radius:8px; margin-bottom:10px;" autoplay="true"></video>
                                <button onclick="startBarcodeScanner()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                                    üì∑ Kamerayƒ± A√ß - Barkodu Tara
                                </button>
                                <button id="stopScannerBtn" style="display:none;" onclick="stopBarcodeScanner()" class="w-full bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-bold mt-2">
                                    ‚úï Kamerayi Kapat
                                </button>
                                <p class="text-xs text-gray-600 mt-2 text-center">veya barkodu manuel olarak yazƒ±n :</p>
                            </div>

                            <!-- Product Form -->
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Barkod Numarasƒ± *</label>
                                    <input id="productBarcode" type="text" placeholder="8693702005439" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none font-mono text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">√úr√ºn Adƒ± *</label>
                                    <input id="productName" type="text" placeholder="√úr√ºn Adƒ±nƒ±z" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Lokasyon *</label>
                                    <select id="productLocation" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-sm">
                                        <option value="Depo A">Depo A</option>
                                        <option value="Depo B">Depo B</option>
                                        <option value="Maƒüaza 1">Maƒüaza 1</option>
                                        <option value="Maƒüaza 2">Maƒüaza 2</option>
                                        <option value="Saha">Saha</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Son Kullanma Tarihi *</label>
                                    <input id="productExpiry" type="date" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-sm">
                                </div>

                                <div id="catalogInfo" style="display:none;" class="p-3 bg-green-50 border-l-4 border-green-500 rounded text-sm">
                                    <p class="text-green-800"><strong>‚úÖ Katalogdan bulundu!</strong></p>
                                    <p id="catalogInfoText" class="text-green-700 text-xs mt-1"></p>
                                </div>

                                <div class="flex gap-3 pt-2">
                                    <button onclick="document.getElementById('productModal').style.display='none'; stopBarcodeScanner();" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg font-bold hover:bg-gray-300">
                                        ƒ∞ptal
                                    </button>
                                    <button onclick="addNewProduct()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-2 rounded-lg font-bold hover:shadow-lg">
                                        ‚úÖ Kaydet
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Leaderboard Modal -->
                    <div id="leaderboardModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-2xl p-6 max-w-2xl w-full shadow-2xl max-h-96 overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">üèÜ Lider Tablosu</h2>
                                <button onclick="document.getElementById('leaderboardModal').style.display='none'" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                            </div>
                            <div class="space-y-3">
                                ${userSystem.getLeaderboard().map((user, idx) => `
                                    <div class="flex items-center gap-4 p-4 ${userSystem.currentUser.username === user.username ? 'bg-purple-100 border-2 border-purple-500' : 'bg-gray-50'} rounded-lg">
                                        <span class="text-2xl font-bold text-gray-400 w-8">${idx + 1}</span>
                                        <div class="flex-1">
                                            <p class="font-bold text-gray-800">${user.fullName}</p>
                                            <p class="text-sm text-gray-600">Level ${user.level} ‚Ä¢ ${user.scans} tarama</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-2xl font-bold text-purple-600">${user.points}</p>
                                            <p class="text-xs text-gray-500">puan</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Audit Log Modal -->
                    <div id="auditModal" style="display:none;" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                        <div class="bg-white rounded-2xl p-6 max-w-4xl w-full shadow-2xl max-h-96 overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-gray-800">üìã ƒ∞≈ülem G√ºnl√ºƒü√º</h2>
                                <button onclick="document.getElementById('auditModal').style.display='none'" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                            </div>
                            <div class="space-y-3">
                                ${userSystem.auditLog.slice().reverse().slice(0, 50).map(log => `
                                    <div class="border-l-4 border-blue-500 p-4 bg-gray-50 rounded">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-bold text-gray-800">${log.action}</p>
                                                <p class="text-sm text-gray-600">Kullanƒ±cƒ±: ${log.username}</p>
                                                <p class="text-sm text-gray-600">Detaylar: ${JSON.stringify(log.details)}</p>
                                            </div>
                                            <span class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString('tr-TR')}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdminPanel() {
            const allUsers = userSystem.getAllUsers();
            const totalProducts = allUsers.reduce((sum, user) => sum + user.products.length, 0);
            const totalScans = allUsers.reduce((sum, user) => sum + user.stats.weeklyScans, 0);

            return `
                <div class="min-h-screen bg-gray-100">
                    <!-- Admin Header -->
                    <div class="bg-red-600 text-white shadow-lg">
                        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                            <div>
                                <h1 class="text-3xl font-bold">‚öôÔ∏è Admin Panel</h1>
                                <p class="text-red-100">Y√∂netim Paneli</p>
                            </div>
                            <button onclick="userSystem.logout(); render();" class="bg-white text-red-600 px-6 py-3 rounded-lg font-bold hover:shadow-lg">
                                √áƒ±kƒ±≈ü Yap
                            </button>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="max-w-7xl mx-auto px-4 py-6">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-white rounded-xl p-6 shadow-lg">
                                <p class="text-gray-600 mb-2">Toplam Kullanƒ±cƒ±</p>
                                <p class="text-4xl font-bold text-blue-600">${allUsers.length}</p>
                            </div>
                            <div class="bg-white rounded-xl p-6 shadow-lg">
                                <p class="text-gray-600 mb-2">Toplam √úr√ºn</p>
                                <p class="text-4xl font-bold text-green-600">${totalProducts}</p>
                            </div>
                            <div class="bg-white rounded-xl p-6 shadow-lg">
                                <p class="text-gray-600 mb-2">Haftalƒ±k Tarama</p>
                                <p class="text-4xl font-bold text-purple-600">${totalScans}</p>
                            </div>
                            <div class="bg-white rounded-xl p-6 shadow-lg">
                                <p class="text-gray-600 mb-2">ƒ∞≈ülem Kayƒ±tlarƒ±</p>
                                <p class="text-4xl font-bold text-orange-600">${userSystem.auditLog.length}</p>
                            </div>
                        </div>

                        <!-- Users Management -->
                        <div class="bg-white rounded-xl p-6 shadow-lg">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Kullanƒ±cƒ± Y√∂netimi</h2>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm">
                                    <thead class="bg-gray-200">
                                        <tr>
                                            <th class="px-4 py-2">Ad Soyad</th>
                                            <th class="px-4 py-2">Kullanƒ±cƒ± Adƒ±</th>
                                            <th class="px-4 py-2">Email</th>
                                            <th class="px-4 py-2">Toplam XP</th>
                                            <th class="px-4 py-2">√úr√ºn Sayƒ±sƒ±</th>
                                            <th class="px-4 py-2">Kayƒ±t Tarihi</th>
                                            <th class="px-4 py-2">Durum</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${allUsers.map(user => `
                                            <tr class="border-b hover:bg-gray-50">
                                                <td class="px-4 py-3">${user.fullName}</td>
                                                <td class="px-4 py-3">${user.username}</td>
                                                <td class="px-4 py-3">${user.email}</td>
                                                <td class="px-4 py-3"><span class="font-bold text-purple-600">${user.stats.totalPoints}</span></td>
                                                <td class="px-4 py-3">${user.products.length}</td>
                                                <td class="px-4 py-3">${new Date(user.createdAt).toLocaleDateString('tr-TR')}</td>
                                                <td class="px-4 py-3">
                                                    <span class="${user.active ? 'bg-green-200 text-green-800' : 'bg-red-200 text-red-800'} px-3 py-1 rounded-full text-xs font-bold">
                                                        ${user.active ? 'Aktif' : 'Deaktif'}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Recent Audit Logs -->
                        <div class="bg-white rounded-xl p-6 shadow-lg mt-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Son 20 ƒ∞≈ülem</h2>
                            <div class="space-y-3 max-h-96 overflow-y-auto">
                                ${userSystem.auditLog.slice().reverse().slice(0, 20).map(log => `
                                    <div class="border-l-4 border-blue-500 p-3 bg-gray-50 rounded">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-bold text-gray-800 text-sm">${log.action}</p>
                                                <p class="text-xs text-gray-600">Kullanƒ±cƒ±: ${log.username}</p>
                                            </div>
                                            <span class="text-xs text-gray-500">${new Date(log.timestamp).toLocaleString('tr-TR')}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper Functions
        function toggleRegister() {
            const fields = document.getElementById('registerFields');
            fields.style.display = fields.style.display === 'none' ? 'block' : 'none';
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                showToast('L√ºtfen t√ºm alanlarƒ± doldurun!', 'error');
                return;
            }

            const registerFields = document.getElementById('registerFields');
            if (registerFields.style.display !== 'none') {
                // Register
                const fullName = document.getElementById('fullName').value.trim();
                const email = document.getElementById('email').value.trim();

                if (!fullName || !email) {
                    showToast('L√ºtfen t√ºm alanlarƒ± doldurun!', 'error');
                    return;
                }

                const result = userSystem.register(username, email, password, fullName);
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) {
                    document.getElementById('registerFields').style.display = 'none';
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                }
            } else {
                // Login
                const result = userSystem.login(username, password);
                showToast(result.message, result.success ? 'success' : 'error');
                if (result.success) {
                    render();
                }
            }
        }

        function showAddProductModal() {
            // Modal'ƒ± g√∂ster
            const modal = document.getElementById('productModal');
            if (modal) {
                modal.style.display = 'flex';
            }
            
            // Form alanlarƒ±nƒ± sƒ±fƒ±rla
            document.getElementById('productBarcode').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productLocation').value = 'Depo A';
            document.getElementById('productExpiry').value = '';
            
            // Katalog bilgisi panelini gizle
            const catalogInfo = document.getElementById('catalogInfo');
            if (catalogInfo) {
                catalogInfo.style.display = 'none';
            }

            // Scanning'i durdur (eƒüer hala aktifse)
            if (scanningActive) {
                stopBarcodeScanner();
            }
            
            // Katalog durumunu kontrol et
            if (!productCatalog.loaded) {
                console.warn('[MODAL] Katalog hala y√ºkleniyor, y√ºkleme sabirsƒ±zca tekrar ba≈ülat');
                productCatalog.loadCatalog().catch(err => {
                    console.error('[MODAL] Katalog y√ºkleme hatasƒ±:', err);
                });
            }
        }

        let codeReader = null;
        let scanningActive = false;

        async function startBarcodeScanner() {
            try {
                const videoElement = document.getElementById('scannerVideo');
                if (!videoElement) {
                    showToast('Video elementi bulunamadƒ±!', 'error');
                    return;
                }

                // ZXing k√ºt√ºphanesinin y√ºkl√ºn√ºp y√ºklenmediƒüini kontrol et
                if (typeof ZXing === 'undefined') {
                    showToast('ZXing k√ºt√ºphanesi hen√ºz y√ºklenmedi!', 'error');
                    return;
                }

                // Kamera eri≈üimi isteyin
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });

                videoElement.style.display = 'block';
                videoElement.srcObject = stream;
                
                // Stop button'ƒ± g√∂ster
                const stopBtn = document.getElementById('stopScannerBtn');
                if (stopBtn) stopBtn.style.display = 'block';

                // ZXing reader'ƒ±nƒ± initialize et
                codeReader = new ZXing.BrowserMultiFormatReader();
                scanningActive = true;

                // Decoding i≈ülemini ba≈ülat (promise tabanlƒ±)
                const decodePromise = codeReader.decodeFromVideoElement(videoElement);
                
                decodePromise.then((result) => {
                    if (result && scanningActive) {
                        const barcode = result.text || result.getText?.();
                        if (barcode) {
                            handleBarcodeScanned(barcode);
                        }
                    }
                }).catch((error) => {
                    // Scanning sƒ±rasƒ±nda hata bekleniyor, sessiz devam et
                    console.debug('[SCAN] Scanning:', error?.message);
                });

                showToast('üì∑ Kamera a√ßƒ±ldƒ± - Barkodu kameraya g√∂ster', 'success');
            } catch (error) {
                console.error('[SCAN] Kamera hatasƒ±:', error);
                if (error.name === 'NotAllowedError') {
                    showToast('‚ùå Kamera eri≈üimi reddedildi!', 'error');
                } else if (error.name === 'NotFoundError') {
                    showToast('‚ùå Kamera bulunamadƒ±!', 'error');
                } else {
                    showToast('‚ùå Kamera a√ßƒ±lamadƒ±: ' + error.message, 'error');
                }
            }
        }

        function stopBarcodeScanner() {
            scanningActive = false;
            
            if (codeReader) {
                try {
                    codeReader.reset();
                } catch (e) {
                    console.debug('[SCAN] Reset hatasƒ±:', e);
                }
                codeReader = null;
            }

            const videoElement = document.getElementById('scannerVideo');
            if (videoElement && videoElement.srcObject) {
                videoElement.srcObject.getTracks().forEach(track => {
                    try {
                        track.stop();
                    } catch (e) {
                        console.debug('[SCAN] Track stop hatasƒ±:', e);
                    }
                });
                videoElement.srcObject = null;
                videoElement.style.display = 'none';
            }

            // Button durumlarƒ±nƒ± g√ºncelle
            const stopBtn = document.getElementById('stopScannerBtn');
            if (stopBtn) stopBtn.style.display = 'none';
        }

        function handleBarcodeScanned(barcode) {
            console.log('[SCAN] Barkod okundu:', barcode);
            
            if (!barcode || barcode.trim() === '') {
                showToast('‚ö†Ô∏è Ge√ßersiz barkod!', 'warning');
                return;
            }

            // Katalogda ara (wait for it to load if needed)
            const catalogProduct = productCatalog.findByBarcode(barcode);
            
            // Barkod alanƒ±nƒ± doldur
            const productBarcodeField = document.getElementById('productBarcode');
            if (productBarcodeField) {
                productBarcodeField.value = barcode;
            }

            const catalogInfo = document.getElementById('catalogInfo');
            
            if (catalogProduct) {
                // Katalogda bulundu - bilgileri otomatik doldur
                console.log('[SCAN] Katalogda bulundu:', catalogProduct.name);
                
                const nameField = document.getElementById('productName');
                const locationField = document.getElementById('productLocation');
                const expiryField = document.getElementById('productExpiry');
                
                if (nameField) nameField.value = catalogProduct.name;
                if (locationField) locationField.value = catalogProduct.locations?.[0] || 'Depo A';
                if (expiryField) expiryField.value = productCatalog.getDefaultExpiry(barcode) || '';
                
                // Katalog bilgisini g√∂ster
                const catalogInfoText = document.getElementById('catalogInfoText');
                if (catalogInfoText) {
                    catalogInfoText.textContent = 
                        `‚úÖ ${catalogProduct.name} - ${catalogProduct.brand} - Ge√ßerlilik: ${catalogProduct.expiryDays} g√ºn`;
                }
                if (catalogInfo) {
                    catalogInfo.style.display = 'block';
                }
                
                showToast(`‚úÖ √úr√ºn bulundu: ${catalogProduct.name}`, 'success');
            } else {
                // Katalogda yok - manuel giri≈üe hazƒ±r
                console.log('[SCAN] Barkod katalogda bulunamadƒ±');
                
                const nameField = document.getElementById('productName');
                const locationField = document.getElementById('productLocation');
                const expiryField = document.getElementById('productExpiry');
                
                if (nameField) nameField.value = '';
                if (locationField) locationField.value = 'Depo A';
                if (expiryField) expiryField.value = '';
                
                if (catalogInfo) {
                    catalogInfo.style.display = 'none';
                }
                
                showToast('‚ö†Ô∏è Barkod katalogda bulunamadƒ± - manuel giri≈ü yapƒ±n', 'warning');
            }
            
            // Scanning'i durdur
            stopBarcodeScanner();
        }

        function addNewProduct() {
            const name = document.getElementById('productName').value.trim();
            const barcode = document.getElementById('productBarcode').value.trim();
            const location = document.getElementById('productLocation').value.trim();
            const expiryDate = document.getElementById('productExpiry').value;

            if (!name || !barcode || !location || !expiryDate) {
                showToast('L√ºtfen t√ºm alanlarƒ± doldurun!', 'error');
                return;
            }

            const status = userSystem.calculateStatus(expiryDate);
            const catalogProduct = productCatalog.findByBarcode(barcode);
            
            const product = { 
                name, 
                barcode, 
                location, 
                expiryDate, 
                ...status,
                isFromCatalog: !!catalogProduct,
                catalogReference: catalogProduct?.name || null
            };

            userSystem.addProduct(userSystem.currentUser.username, product);
            showToast('‚úÖ √úr√ºn ba≈üarƒ±yla eklendi!', 'success');
            
            // Modal kapat ve form temizle
            document.getElementById('productModal').style.display = 'none';
            stopBarcodeScanner();
            document.getElementById('productName').value = '';
            document.getElementById('productBarcode').value = '';
            document.getElementById('productLocation').value = 'Depo A';
            document.getElementById('productExpiry').value = '';
            document.getElementById('catalogInfo').style.display = 'none';
            
            render();
        }

        function viewLeaderboard() {
            document.getElementById('leaderboardModal').style.display = 'flex';
        }

        function viewAuditLog() {
            document.getElementById('auditModal').style.display = 'flex';
        }

        // Demo i√ßin test account
        if (Object.keys(userSystem.users).length === 0) {
            userSystem.register('demo', 'demo@example.com', 'demo123', 'Demo Kullanƒ±cƒ±');
            userSystem.register('admin', 'admin@example.com', 'admin123', 'Admin Kullanƒ±cƒ±');
            userSystem.users['admin'].role = 'admin';
            userSystem.saveData('users', userSystem.users);
            console.log('[DEMO] Test accounts created: demo/demo123 and admin/admin123');
        }

        // Initial render
        document.addEventListener('DOMContentLoaded', () => {
            render();
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('[SW] registered'))
                    .catch(err => console.log('[SW] error:', err));
            });
        }
    </script>
</body>
</html>
